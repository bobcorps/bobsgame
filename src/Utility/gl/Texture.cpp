#include "stdafx.h"

//#pragma once




//Logger Texture::log = Logger("Texture");

shared_ptr<BobTexture >BobTexture::lastBoundTexture = nullptr;

//=========================================================================================================================
shared_ptr<BobTexture >BobTexture::getLastBoundTexture()
{//=========================================================================================================================
	return lastBoundTexture;
}


//=========================================================================================================================
BobTexture::BobTexture(const string &cacheName, GLuint textureID)
{//=========================================================================================================================
	this->glTargetType = GL_TEXTURE_2D;
	this->cacheName = cacheName;
	this->textureID = textureID;
	lastBoundTexture = this;
}



//=========================================================================================================================
bool BobTexture::hasAlpha()
{//=========================================================================================================================
	return alpha;
}



//=========================================================================================================================
void BobTexture::setAlpha(bool alpha)
{//=========================================================================================================================
	this->alpha = alpha;
}

//=========================================================================================================================
void BobTexture::bindNone()
{//=========================================================================================================================

	lastBoundTexture = nullptr;
	glDisable(GL_TEXTURE_2D);
}

//=========================================================================================================================
void BobTexture::unbind()
{//=========================================================================================================================

	lastBoundTexture = nullptr;
}

//=========================================================================================================================
void BobTexture::bind()
{//=========================================================================================================================
	if (lastBoundTexture != this)
	{
		lastBoundTexture = this;
		glEnable(GL_TEXTURE_2D);
		glBindTexture(glTargetType, textureID);
	}
}

//=========================================================================================================================
void BobTexture::setImageHeight(int imageHeight)
{//=========================================================================================================================
	this->imageHeight = imageHeight;
	setHeightRatio();
}

//=========================================================================================================================
void BobTexture::setImageWidth(int imageWidth)
{//=========================================================================================================================
	this->imageWidth = imageWidth;
	setWidthRatio();
}

//=========================================================================================================================
int BobTexture::getImageHeight()
{//=========================================================================================================================
	return imageHeight;
}

//=========================================================================================================================
int BobTexture::getImageWidth()
{//=========================================================================================================================
	return imageWidth;
}

//=========================================================================================================================
float BobTexture::getHeightRatio()
{//=========================================================================================================================
	return heightRatio;
}

//=========================================================================================================================
float BobTexture::getWidthRatio()
{//=========================================================================================================================
	return widthRatio;
}

//=========================================================================================================================
int BobTexture::getTextureHeight()
{//=========================================================================================================================
	return texHeight;
}

//=========================================================================================================================
int BobTexture::getTextureWidth()
{//=========================================================================================================================
	return texWidth;
}

//=========================================================================================================================
void BobTexture::setTextureHeight(int texHeight)
{//=========================================================================================================================
	this->texHeight = texHeight;
	setHeightRatio();
}

//=========================================================================================================================
void BobTexture::setTextureWidth(int texWidth)
{//=========================================================================================================================
	this->texWidth = texWidth;
	setWidthRatio();
}

//=========================================================================================================================
void BobTexture::setHeightRatio()
{//=========================================================================================================================
	if (texHeight != 0)
	{
		heightRatio = (static_cast<float>(imageHeight)) / texHeight;
	}
}


//=========================================================================================================================
void BobTexture::setWidthRatio()
{//=========================================================================================================================
	if (texWidth != 0)
	{
		widthRatio = (static_cast<float>(imageWidth)) / texWidth;
	}
}

//=========================================================================================================================
void BobTexture::release()
{//=========================================================================================================================


	shared_ptr<GLuint >textureIDs = make_shared<GLuint>[1];
	textureIDs[0] = textureID;

	glDeleteTextures(1, textureIDs);

	delete[] textureIDs;

	if (lastBoundTexture == this)
	{
		bindNone();
	}

	if (cacheName != "")
	{
		GLUtils::clearCache(cacheName);
	}


	GLUtils::texturesLoaded--;
	GLUtils::textureBytesLoaded -= (getTextureWidth() * getTextureHeight() * 4);


}

//=========================================================================================================================
GLuint BobTexture::getTextureID()
{//=========================================================================================================================
	return textureID;
}

//=========================================================================================================================
void BobTexture::setTextureID(GLuint textureID)
{//=========================================================================================================================
	this->textureID = textureID;
}

//=========================================================================================================================
shared_ptr<ByteArray> BobTexture::getTextureData()
{//=========================================================================================================================
	shared_ptr<ByteArray >buffer = make_shared<ByteArray>((hasAlpha() ? 4 : 3) * texWidth * texHeight);
	bind();
	glGetTexImage(GL_TEXTURE_2D, 0, hasAlpha() ? GL_RGBA : GL_RGB, GL_UNSIGNED_BYTE, buffer->data());


	return buffer;
}
